#!/bin/bash
set -euo pipefail

CLAUDE_ROOT="$HOME/.claude"
SESSIONS_DIR="$CLAUDE_ROOT/sessions"
CLAUDE_BIN="$(which claude 2>/dev/null || echo /usr/bin/claude)"
UPDATE_SCRIPT="$CLAUDE_ROOT/bin/check-update.sh"

RED="\033[0;31m"
GREEN="\033[0;32m"
YELLOW="\033[1;33m"
BLUE="\033[0;34m"
NC="\033[0m"

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Check for updates before launching session (non-blocking)
check_for_updates() {
    if [ -x "$UPDATE_SCRIPT" ]; then
        log_info "Checking for Claude Code updates..."
        "$UPDATE_SCRIPT" &
        # Don't wait for update check to complete
    fi
}

generate_uuid() { cat /proc/sys/kernel/random/uuid; }

create_session_dir() {
    local session_id="$1"
    local session_dir="$SESSIONS_DIR/$session_id"
    
    mkdir -p "$session_dir"/{todos,shell-snapshots,file-history,debug,project/-home-mdoehler,mcp-state}
    touch "$session_dir"/{history.jsonl,session.log}
    
    log_success "Created session directory: $session_dir"
}

launch_claude() {
    local session_id="$1"
    local session_name="$2"
    shift 2
    
    local session_dir="$SESSIONS_DIR/$session_id"
    
    # CRITICAL FIX: Set CLAUDE_CONFIG_DIR to session directory
    # Claude Code hardcodes history path to $CLAUDE_CONFIG_DIR/history.jsonl
    export CLAUDE_CONFIG_DIR="$session_dir"
    export CLAUDE_SESSION_ID="$session_id"
    export CLAUDE_SESSION_NAME="$session_name"
    
    log_info "Session ID: $session_id"
    log_info "Session Name: $session_name"
    log_info "History file: $session_dir/history.jsonl"
    log_warn "Launching with --dangerously-skip-permissions"
    
    ln -sf "$session_dir" "$SESSIONS_DIR/active/$session_id"
    
    exec "$CLAUDE_BIN" --dangerously-skip-permissions "$@"
}

if [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]]; then
    echo "Usage: claude-session [session-name]"
    echo "Note: Runs with --dangerously-skip-permissions"
    exit 0
fi

# Check for updates (non-blocking)
check_for_updates

session_name="${1:-session-$(date +%Y%m%d-%H%M%S)}"
shift || true

session_id=$(generate_uuid)

log_info "Creating session: $session_name"
create_session_dir "$session_id"
launch_claude "$session_id" "$session_name" "$@"
